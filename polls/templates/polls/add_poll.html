{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h3>New Poll</h3>
  <hr>

  {# Django messages already show your "Please provide at least two choices." #}

  <form method="post" novalidate>
    {% csrf_token %}

    <div class="form-group mb-3">
      <label for="id_text">Text:</label>
      {{ form.text }}
      {% if form.text.errors %}
        <div class="text-danger small">{{ form.text.errors }}</div>
      {% endif %}
    </div>

    <div class="form-group mb-3">
      <label>Choices</label>
      <div id="choices-container">
        {% if posted_choices %}
          {% for c in posted_choices %}
            <div class="input-group mb-2 choice-row">
              <input type="text" name="choices" class="form-control" value="{{ c|escape }}" placeholder="Choice">
              <button type="button" class="btn btn-outline-secondary remove-choice" aria-label="Remove">&times;</button>
            </div>
          {% endfor %}
        {% else %}
          <div class="input-group mb-2 choice-row">
            <input type="text" name="choices" class="form-control" placeholder="Choice">
            <button type="button" class="btn btn-outline-secondary remove-choice" aria-label="Remove">&times;</button>
          </div>
          <div class="input-group mb-2 choice-row">
            <input type="text" name="choices" class="form-control" placeholder="Choice">
            <button type="button" class="btn btn-outline-secondary remove-choice" aria-label="Remove">&times;</button>
          </div>
        {% endif %}
      </div>

      <button id="add-choice" type="button" class="btn btn-sm btn-outline-primary mt-2">+ Add choice</button>
      <div class="form-text">You need at least two choices.</div>
    </div>

    <button type="submit" class="btn btn-primary">Create</button>
    <a href="{% url 'polls:list' %}" class="btn btn-link">Cancel</a>
  </form>
</div>

<script>
(function () {
  const container = document.getElementById('choices-container');
  const addBtn = document.getElementById('add-choice');

  function makeRow(value = '') {
    const wrap = document.createElement('div');
    wrap.className = 'input-group mb-2 choice-row';
    wrap.innerHTML = `
      <input type="text" name="choices" class="form-control" placeholder="Choice" value="${value.replace(/"/g,'&quot;')}">
      <button type="button" class="btn btn-outline-secondary remove-choice" aria-label="Remove">&times;</button>
    `;
    return wrap;
  }

  addBtn.addEventListener('click', () => container.appendChild(makeRow()));

  container.addEventListener('click', (e) => {
    if (e.target && e.target.classList.contains('remove-choice')) {
      const rows = container.querySelectorAll('.choice-row');
      if (rows.length > 1) e.target.closest('.choice-row').remove();
    }
  });
})();
</script>
{% endblock %}
